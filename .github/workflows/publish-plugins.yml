name: Publish Plugins

permissions:
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/**'
      - '.github/workflows/plugins.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create releases folder
        run: mkdir -p releases

      - name: Zip all plugins
        run: |
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            zip -r "releases/$plugin_name.zip" "$plugin_dir"
          done

      - name: Generate manifest.json with commit dates
        run: |
          MANIFEST="manifest.json"
          echo '{ "plugins": [' > tmp_manifest.json
          FIRST=true
          for plugin_dir in plugins/*/; do
            plugin_file="$plugin_dir/plugin.json"
            if [ -f "$plugin_file" ]; then
              # Use last commit date of plugin.json for manifest
              DATE=$(git log -1 --format=%cI -- "$plugin_file")
              PLUGIN_JSON=$(jq --arg date "$DATE" '. + {date: $date}' "$plugin_file")
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> tmp_manifest.json
              fi
              echo "$PLUGIN_JSON" >> tmp_manifest.json
            fi
          done
          echo "]}" >> tmp_manifest.json
          mv tmp_manifest.json $MANIFEST

      - name: Update README.md with plugin table
        run: |
          MD_FILE="README.md"
          TABLE_HEADER="| Name | Version | Owner | Maintainers | Date | ZIP |"
          TABLE_DIVIDER="|------|--------|-------|------------|------|-----|"
          TABLE_ROWS=""
          for plugin_dir in plugins/*/; do
            PLUGIN_JSON="$plugin_dir/plugin.json"
            if [ -f "$PLUGIN_JSON" ]; then
              NAME=$(jq -r '.name' "$PLUGIN_JSON")
              VERSION=$(jq -r '.version' "$PLUGIN_JSON")
              OWNER=$(jq -r '.owner' "$PLUGIN_JSON")
              MAINTAINERS=$(jq -r '[.maintainers[]?] | join(", ")' "$PLUGIN_JSON")
              DATE=$(git log -1 --format=%cI -- "$PLUGIN_JSON")
              ZIP_URL="https://github.com/${GITHUB_REPOSITORY}/raw/main/releases/$(basename $plugin_dir).zip"
              TABLE_ROWS+="| $NAME | $VERSION | $OWNER | $MAINTAINERS | $DATE | [ZIP]($ZIP_URL) |\n"
            fi
          done

          # Remove any previous plugin table (between <!-- PLUGIN_TABLE_START --> and <!-- PLUGIN_TABLE_END -->)
          awk '/<!-- PLUGIN_TABLE_START -->/{flag=1;print;print "'"$TABLE_HEADER"'";print "'"$TABLE_DIVIDER"'";next} /<!-- PLUGIN_TABLE_END -->/{flag=0;print "'"$TABLE_ROWS"'"} !flag' "$MD_FILE" > tmp_readme.md

          # If no table markers, append at the end
          if ! grep -q '<!-- PLUGIN_TABLE_START -->' "$MD_FILE"; then
            echo -e '\n<!-- PLUGIN_TABLE_START -->\n'$TABLE_HEADER'\n'$TABLE_DIVIDER'\n'$TABLE_ROWS'<!-- PLUGIN_TABLE_END -->' >> tmp_readme.md
          fi

          mv tmp_readme.md "$MD_FILE"

      - name: Commit ZIPs, manifest, and README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add releases manifest.json README.md
          git diff-index --quiet HEAD || git commit -m "Update plugin ZIPs, manifest, and README.md [skip ci]"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main