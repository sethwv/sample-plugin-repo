name: Validate & Enforce Plugin Ownership

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - ready_for_review
    paths:
      - 'plugins/**'
      - '.github/workflows/plugins.yml'

jobs:
  draft-notice:
    if: ${{ github.event.pull_request.draft == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Authenticate GH CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status

      - name: Post draft notice
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="<!--PLUGIN_VALIDATION_DRAFT_NOTICE-->"
          COMMENT+=$'\n'"⚠️ This PR is currently a draft. Plugin validation will run once the PR is marked ready for review."
          EXISTING_COMMENT_ID=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.author.login=="github-actions[bot]") | select(.body | contains("<!--PLUGIN_VALIDATION_DRAFT_NOTICE-->")) | .id')
          if [ -n "$EXISTING_COMMENT_ID" ]; then
            gh pr comment edit $EXISTING_COMMENT_ID --body "$COMMENT"
          else
            gh pr comment $PR_NUMBER --body "$COMMENT"
          fi

  validate-and-comment:
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Authenticate GH CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status

      - name: Validate plugin(s) and build PR comment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="<!--PLUGIN_VALIDATION_COMMENT-->"
          COMMENT+=$'\n'"### Plugin Validation Results"
          COMMENT+=$'\n'

          FAILED=0
          PR_AUTHOR="${{ github.actor }}"

          # Get modified plugin directories
          PLUGIN_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'plugins/' | cut -d '/' -f2 | sort -u | uniq)

          # Enforce single plugin per PR
          PLUGIN_COUNT=$(echo "$PLUGIN_DIRS" | wc -l)
          if [ "$PLUGIN_COUNT" -ne 1 ]; then
            COMMENT+=$'\n'"❌ **Error:** PR must only modify one plugin. Detected $PLUGIN_COUNT plugins."
            FAILED=1
          fi

          for plugin in $PLUGIN_DIRS; do
            PLUGIN_JSON="plugins/$plugin/plugin.json"
            README="plugins/$plugin/README.md"
            COMMENT+=$'\n'"- **$plugin**:"
            PLUGIN_FAILED=0

            # plugin.json check
            if [ ! -f "$PLUGIN_JSON" ]; then
              COMMENT+=$'\n'"  - ❌ plugin.json missing"
              PLUGIN_FAILED=1
            else
              COMMENT+=$'\n'"  - ✅ plugin.json exists"
            fi

            # README check
            if [ ! -f "$README" ]; then
              COMMENT+=$'\n'"  - ❌ README.md missing"
              PLUGIN_FAILED=1
            else
              COMMENT+=$'\n'"  - ✅ README.md exists"
            fi

            # JSON validation and owner/maintainers/version checks
            if [ -f "$PLUGIN_JSON" ]; then
              if ! cat "$PLUGIN_JSON" | node -e "try{JSON.parse(require('fs').readFileSync(0,'utf-8'));}catch(e){process.exit(1);}"; then
                COMMENT+=$'\n'"  - ❌ Invalid JSON"
                PLUGIN_FAILED=1
              else
                COMMENT+=$'\n'"  - ✅ JSON valid"
              fi

              OWNER=$(jq -r '.owner' "$PLUGIN_JSON")
              MAINTAINERS=$(jq -r '[.maintainers[]?] | join(" ")' "$PLUGIN_JSON")
              MAINTAINERS="${MAINTAINERS:-}"

              if [[ "$PR_AUTHOR" != "$OWNER" ]] && [[ ! " $MAINTAINERS " =~ " $PR_AUTHOR " ]]; then
                COMMENT+=$'\n'"  - ⚠️ You are not the owner or a maintainer"
                PLUGIN_FAILED=1
              else
                COMMENT+=$'\n'"  - ✅ Owner/maintainer check passed"
              fi

              VERSION=$(jq -r '.version' "$PLUGIN_JSON")
              if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                COMMENT+=$'\n'"  - ✅ Version semantic check passed ($VERSION)"
              else
                COMMENT+=$'\n'"  - ⚠️ Version not semantic ($VERSION)"
              fi

              # Version bump for existing plugin
              if git show origin/main:"$PLUGIN_JSON" > /dev/null 2>&1; then
                OLD_VERSION=$(git show origin/main:"$PLUGIN_JSON" | jq -r '.version')
                IFS='.' read -r OLD_MAJOR OLD_MINOR OLD_PATCH <<< "$OLD_VERSION"
                IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$VERSION"

                if (( NEW_MAJOR < OLD_MAJOR )) || \
                   (( NEW_MAJOR == OLD_MAJOR && NEW_MINOR < OLD_MINOR )) || \
                   (( NEW_MAJOR == OLD_MAJOR && NEW_MINOR == OLD_MINOR && NEW_PATCH <= OLD_PATCH )); then
                  COMMENT+=$'\n'"  - ❌ Version must be incremented from $OLD_VERSION → $VERSION"
                  PLUGIN_FAILED=1
                else
                  COMMENT+=$'\n'"  - ✅ Version bump OK ($OLD_VERSION → $VERSION)"
                fi
              else
                # New plugin → report version
                COMMENT+=$'\n'"  - ✅ New plugin version ($VERSION)"
              fi
            fi

            if [ "$PLUGIN_FAILED" -eq 0 ]; then
              COMMENT+=$'\n'"  - ✅ All checks passed for $plugin"
            else
              FAILED=1
            fi
          done

          # Post or update single PR comment
          EXISTING_COMMENT_ID=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.author.login=="github-actions[bot]") | select(.body | contains("<!--PLUGIN_VALIDATION_COMMENT-->")) | .id')
          if [ -n "$EXISTING_COMMENT_ID" ]; then
            gh pr comment edit $EXISTING_COMMENT_ID --body "$COMMENT"
          else
            gh pr comment $PR_NUMBER --body "$COMMENT"
          fi

      - name: Fail workflow if any critical errors
        if: ${{ always() }}
        run: |
          if [ "$FAILED" -ne 0 ]; then
            exit 1