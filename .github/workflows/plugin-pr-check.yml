name: Validate & Enforce Plugin Ownership

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    paths:
      - 'plugins/**'

jobs:
  validate-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Validate plugins, add inline annotations, and build PR comment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTHOR: ${{ github.actor }}
        run: |
          COMMENT="### Plugin Validation Results\n\n"
          FAILED=0

          # Get modified plugin directories
          PLUGIN_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'plugins/' | cut -d '/' -f2 | sort -u)

          for plugin in $PLUGIN_DIRS; do
            PLUGIN_JSON="plugins/$plugin/plugin.json"
            README="plugins/$plugin/README.md"
            COMMENT+="- **$plugin**:\n"

            # Check plugin.json existence
            if [ ! -f "$PLUGIN_JSON" ]; then
              echo "::error file=$PLUGIN_JSON::plugin.json missing"
              COMMENT+="  - ❌ plugin.json missing\n"
              FAILED=1
              continue
            fi

            # Check README.md existence
            if [ ! -f "$README" ]; then
              echo "::error file=$README::README.md missing"
              COMMENT+="  - ❌ README.md missing\n"
              FAILED=1
            fi

            # Validate JSON syntax
            if ! cat "$PLUGIN_JSON" | node -e "try{JSON.parse(require('fs').readFileSync(0,'utf-8'));}catch(e){process.exit(1);}"; then
              echo "::error file=$PLUGIN_JSON::Invalid JSON"
              COMMENT+="  - ❌ Invalid JSON\n"
              FAILED=1
            fi

            # Check ownership
            OWNER=$(jq -r '.owner' "$PLUGIN_JSON")
            MAINTAINERS=$(jq -r '[.maintainers[]?] | join(" ")' "$PLUGIN_JSON")
            if [[ "$AUTHOR" != "$OWNER" ]] && [[ ! " $MAINTAINERS " =~ " $AUTHOR " ]]; then
              echo "::warning file=$PLUGIN_JSON::You are not the owner or a maintainer"
              COMMENT+="  - ⚠️ You are not the owner or maintainer\n"
            fi

            # Version check
            VERSION=$(jq -r '.version' "$PLUGIN_JSON")
            if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "::warning file=$PLUGIN_JSON::Version is not semantic (X.Y.Z)"
              COMMENT+="  - ⚠️ Version is not semantic (X.Y.Z)\n"
            fi

            # Success note if no failures for this plugin
            if [ "$FAILED" -eq 0 ]; then
              COMMENT+="  - ✅ Passed all checks\n"
            fi

            COMMENT+=$'\n'
          done

          # Post comment if any results
          if [[ -n "$COMMENT" ]]; then
            gh pr comment $PR_NUMBER --body "$COMMENT"
          fi

      - name: Fail workflow if errors
        if: ${{ always() }}
        run: |
          if [ "$FAILED" -ne 0 ]; then
            exit 1